import { useState } from "react";
import { DateRange } from "react-date-range";
import AddVulnerabilityBar from "../components/AddVulnerabilityBar";
import DetailsForm from "../components/DetailsForm";
import VulnerabilityTable from "../components/VulnerabilityTable";
import {createPentest} from "../Api";

const Main = () => {
  const [dateRetest, setDateRetest] = useState([
    {
      startDate: new Date(),
      endDate: null,
      key: "retestDateRange",
    },
  ]);
  const [dateAudyt, setDateAudyt] = useState([
    {
      startDate: new Date(),
      endDate: null,
      key: "audytDateRange",
    },
  ]);

  const [section12, setSection12] = useState({
    systemName: "",
    testLocalization: "",
    reportVersion: "",
    testsSpecification: "",
    testsConclusions: "",
    testsVulnerabilities: "",
    technicalSummary: "",
    recommendedChanges: "",
  });
  const [vulnerabilities, setVulnerabilities] = useState([]);
  const [auditors, setAuditors] = useState([]);
  const [isResponseReady, setIsResponseReady] = useState(false);

  const addVulnerability = (item) => {
    const tempState = [...vulnerabilities];
    tempState.push({
      name: item.name,
      vulnerabilityLevel: item.vulnerabilityLevel,
      isFixed: item.isFixed,
      localization: null,
      permissions: null,
      description: null,
      fixRecommendations: null,
      statusAfterRetests: null,
    });
    setVulnerabilities(tempState);
  };
  const addDetailsVuln = (key, item) => {
    const tempState = [...vulnerabilities];
    tempState[key] = { ...tempState[key], ...item };
    setVulnerabilities(tempState);
  };


  const createDtoObject = async () => {
    const object = {
      systemName: section12?.systemName,
      testDate: dateAudyt[0]?.startDate,
      testEndDate: dateAudyt[0]?.endDate,
      retestDate: dateRetest[0]?.startDate,
      retestEndDate: dateRetest[0]?.endDate,
      testLocalization: section12?.testLocalization,
      reportVersion: section12?.reportVersion,
      testsSpecification: section12?.testsSpecification,
      testsConclusions: section12?.testsConclusions,
      testsVulnerabilities: section12?.testsVulnerabilities,
      technicalSummary: section12?.technicalSummary,
      recommendedChanges: section12?.recommendedChanges,
      vulnerabilities: vulnerabilities,
      auditors: auditors
    };
    const response = await createPentest(object).catch(err => console.log(err)).then();
    {console.log(response)};
    
    console.log(object);
  };
  return (
    <div className="text-center">
      <h4 className="text-uppercase fw-bold">Sekcje raportu</h4>
      <hr />
      <div className="accordion accordion-flush" id="accordionFlushExample">
        <div className="accordion-item">
          <h2 className="accordion-header" id="flush-headingOne">
            <button
              className="accordion-button collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#flush-collapseOne"
              aria-expanded="false"
              aria-controls="flush-collapseOne"
            >
              1. Informacje ogólne
            </button>
          </h2>
          <div
            id="flush-collapseOne"
            className="accordion-collapse collapse"
            aria-labelledby="flush-headingOne"
            data-bs-parent="#accordionFlushExample"
          >
            <div className="accordion-body">
              <form className="row g-3 mt-3">
                <div className="row mb-3 my-2">
                  <label htmlFor="system" className="col-sm-4 col-form-label">
                    Testowany system
                  </label>
                  <div className="col-sm-8">
                    <input
                      type="text"
                      className="form-control"
                      id="system"
                      value={section12.systemName}
                      onChange={(e) =>
                        setSection12((prev) => ({
                          ...prev,
                          systemName: e.target.value,
                        }))
                      }
                    />
                  </div>
                </div>
                <div className="row mb-3 my-2">
                  <label htmlFor="miejsce" className="col-sm-4 col-form-label">
                    Miejsce wykonywania audytu
                  </label>
                  <div className="col-sm-8">
                    <input
                      type="text"
                      className="form-control"
                      id="miejsce"
                      value={section12.testLocalization}
                      onChange={(e) =>
                        setSection12((prev) => ({
                          ...prev,
                          testLocalization: e.target.value,
                        }))
                      }
                    />
                  </div>
                </div>
                <div className="row mb-3 my-2">
                  <label
                    htmlFor="audytorzy"
                    className="col-sm-4 col-form-label"
                  >
                    Audytorzy wykonujący prace
                  </label>
                  <div className="col-sm-8">
                    <input
                      type="text"
                      className="form-control"
                      id="audytorzy"
                      onChange={(e) => {
                        const listOfAuditors = [];
                        const auditorsInput = e.target.value.toString().split(', ');
                        auditorsInput.map(auditor => {
                          console.log(auditor);
                          const auditorData = auditor.toString().split(' ');
                          listOfAuditors.push({
                            name: auditorData[0],
                            surname: auditorData[1],
                          })
                        });
                        setAuditors(listOfAuditors);
                      }}
                    />
                    {console.log(auditors)}
                  </div>
                </div>
                <div className="row mb-3 my-2">
                  <label htmlFor="wersja" className="col-sm-4 col-form-label">
                    Wersja raportu
                  </label>
                  <div className="col-sm-8">
                    <input
                      type="text"
                      className="form-control"
                      id="wersja"
                      value={section12.reportVersion}
                      onChange={(e) =>
                        setSection12((prev) => ({
                          ...prev,
                          reportVersion: e.target.value,
                        }))
                      }
                    />
                  </div>
                </div>
                <div className="row mb-3 my-2">
                  <div className="col-lg-4 col-12 d-none d-lg-block"></div>

                  <div className="col-lg-4 form-floating float-center col-12">
                    <p className="text-light text-center">Data wykonania audytów</p>
                    <DateRange
                      onChange={(item) => setDateAudyt([item.audytDateRange])}
                      editableDateInputs={true}
                      moveRangeOnFirstSelection={false}
                      ranges={dateAudyt}
                      className="rounded-3"
                    />
                  </div>
                  <div className="col-lg-4 form-floating float-center col-12">
                    <p className="text-light text-center">Data wykonania retestów</p>
                    <DateRange
                      onChange={(item) => setDateRetest([item.retestDateRange])}
                      editableDateInputs={true}
                      moveRangeOnFirstSelection={false}
                      ranges={dateRetest}
                      className="rounded-3"
                    />
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div className="accordion-item">
          <h2 className="accordion-header" id="flush-headingTwo">
            <button
              className="accordion-button collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#flush-collapseTwo"
              aria-expanded="false"
              aria-controls="flush-collapseTwo"
            >
              2. Podsumowanie testów
            </button>
          </h2>
          <div
            id="flush-collapseTwo"
            className="accordion-collapse collapse"
            aria-labelledby="flush-headingTwo"
            data-bs-parent="#accordionFlushExample"
          >
            <div className="accordion-body">
              <div className="accordion-body">
                <form className="row g-3 mt-3">
                  <div className="row mb-3 my-2">
                    <label
                      htmlFor="inputEmail3"
                      className="col-sm-4 col-form-label"
                    >
                      Opis założeń i specyfikacja testu
                    </label>
                    <div className="col-sm-8">
                      <textarea
                        type="text"
                        className="form-control"
                        id="inputEmail3"
                        value={section12.testsSpecification}
                        onChange={(e) =>
                          setSection12((prev) => ({
                            ...prev,
                            testsSpecification: e.target.value,
                          }))
                        }
                      />
                    </div>
                  </div>
                  <div className="row mb-3 my-2">
                    <label
                      htmlFor="wnioski"
                      className="col-sm-4 col-form-label"
                    >
                      Wnioski płynace z testów
                    </label>
                    <div className="col-sm-8">
                      <textarea
                        type="text"
                        className="form-control"
                        id="wnioski"
                        value={section12.testsConclusions}
                        onChange={(e) =>
                          setSection12((prev) => ({
                            ...prev,
                            testsConclusions: e.target.value,
                          }))
                        }
                      />
                    </div>
                  </div>
                  <div className="row mb-3 my-2">
                    <label
                      htmlFor="podatności"
                      className="col-sm-4 col-form-label"
                    >
                      Wskazane podatności
                    </label>
                    <div className="col-sm-8">
                      <textarea
                        type="text"
                        className="form-control"
                        id="podatności"
                        value={section12.testsVulnerabilities}
                        onChange={(e) =>
                          setSection12((prev) => ({
                            ...prev,
                            testsVulnerabilities: e.target.value,
                          }))
                        }
                      />
                    </div>
                  </div>
                  <div className="row mb-3 my-2">
                    <label
                      htmlFor="podsumowanie"
                      className="col-sm-4 col-form-label"
                    >
                      Podsumowanie techniczne
                    </label>
                    <div className="col-sm-8">
                      <textarea
                        type="text"
                        className="form-control"
                        id="podsumowanie"
                        value={section12.technicalSummary}
                        onChange={(e) =>
                          setSection12((prev) => ({
                            ...prev,
                            technicalSummary: e.target.value,
                          }))
                        }
                      />
                    </div>
                  </div>
                  <div className="row mb-3 my-2">
                    <label
                      htmlFor="inputPassword3"
                      className="col-sm-4 col-form-label"
                    >
                      Zalecenia dalszych zmian
                    </label>
                    <div className="col-sm-8">
                      <textarea
                        type="text"
                        className="form-control"
                        id="inputPassword3"
                        value={section12.recommendedChanges}
                        onChange={(e) =>
                          setSection12((prev) => ({
                            ...prev,
                            recommendedChanges: e.target.value,
                          }))
                        }
                      />
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <div className="accordion-item">
          <h2 className="accordion-header" id="flush-headingThree">
            <button
              className="accordion-button collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#flush-collapseThree"
              aria-expanded="false"
              aria-controls="flush-collapseThree"
            >
              3. Wykryte podatności
            </button>
          </h2>
          <div
            id="flush-collapseThree"
            className="accordion-collapse collapse"
            aria-labelledby="flush-headingThree"
            data-bs-parent="#accordionFlushExample"
          >
            <AddVulnerabilityBar submit={addVulnerability} />
            <VulnerabilityTable data={vulnerabilities} />
          </div>
        </div>

        <div className="accordion-item" id="accordionFlushX">
          <h2 className="accordion-header" id="flush-headingFour">
            <button
              className="accordion-button collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#flush-collapseFour"
              aria-expanded="false"
              aria-controls="flush-collapseFour"
            >
              4. Szczegóły wykrytych podatności
            </button>
          </h2>
          <div
            id="flush-collapseFour"
            className="accordion-collapse collapse"
            aria-labelledby="flush-headingFour"
            data-bs-parent="#accordionFlushExample"
          >
            <div className="accordion-body">
              {vulnerabilities &&
                vulnerabilities.map((item, index) => {
                  return (
                    <DetailsForm
                      id={index}
                      item={item}
                      key={index}
                      onSubmit={addDetailsVuln}
                    />
                  );
                })}
            </div>
          </div>
        </div>
      </div>
      <button className="btn btn-warning"
      onClick={() => createDtoObject()}>KONIEC</button>
    </div>
  );
};

export default Main;
